<mxfile host="app.diagrams.net" modified="2022-05-30T13:40:02.265Z" agent="5.0 (X11)" etag="oH4IWiLUFESC5IIOu3eh" version="18.1.3" type="github">
  <diagram id="jVp62vLLjkdQPAXNkaVz" name="Page-1">
    <mxGraphModel dx="868" dy="481" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="ovNifU9Em4_lmZY8JSdp-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-1" target="ovNifU9Em4_lmZY8JSdp-6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-1" value="Rega" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="260" y="120" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-16" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-2" target="ovNifU9Em4_lmZY8JSdp-15">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-2" value="&lt;div&gt;Создаем PGP серт, где &lt;br&gt;&lt;/div&gt;&lt;div&gt;email = CRC32(uid)@&amp;lt;backend.addr&amp;gt;&lt;/div&gt;&lt;div&gt;и name = device.hostname&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Сохраняем его в кейчейн с пометкой НЕ СИНКАТЬ&lt;/div&gt;&lt;div&gt;шлем PGP.Pub на бек&lt;br&gt;&lt;/div&gt;" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;size=0.02631578947368421;" vertex="1" parent="1">
          <mxGeometry x="130" y="440" width="380" height="130" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-6" target="ovNifU9Em4_lmZY8JSdp-12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-6" value="&lt;div&gt;Выбирает общий&lt;/div&gt;&lt;div&gt;или свой бэкенд&lt;/div&gt;" style="shape=trapezoid;perimeter=trapezoidPerimeter;whiteSpace=wrap;html=1;fixedSize=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="235" y="200" width="170" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-12" target="ovNifU9Em4_lmZY8JSdp-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-12" value="&lt;div&gt;Пробегаем по Эпловой реге, достаем uid&lt;/div&gt;" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="260" y="320" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-15" value="&lt;div&gt;Сохраняем серт, получаем ID от базы, возвращаем его клиенту. Теперь это его &lt;b&gt;CertID&lt;/b&gt;&lt;/div&gt;&lt;div&gt;ID юзера = первая часть до собаки в email&lt;/div&gt;&lt;div&gt;Вторая - это признак того где он зарегался&lt;br&gt;&lt;/div&gt;&lt;div&gt;Например, 00fadb@xproject.ru - юзер зареган на нашей, публичной федерации&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;Можно будет потом еще тут выдавать серт сервера, чтобы им ты подписал свой, так траст будет выше&lt;br&gt;&lt;/div&gt;, если чел например поднял свой бэк, наклепал ботов кароче и они попиздили заебывать друге федерации." style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;size=0.045454545454545456;" vertex="1" parent="1">
          <mxGeometry x="155" y="640" width="330" height="360" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-17" target="ovNifU9Em4_lmZY8JSdp-18">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-17" value="Любой запрос&lt;br&gt;Клиент" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="620" y="120" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-18" target="ovNifU9Em4_lmZY8JSdp-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-18" value="&lt;div&gt;HTTP клиент на основе&lt;/div&gt;&lt;div&gt;PGP серта из домена имейла достает домен или ip &lt;/div&gt;" style="shape=trapezoid;perimeter=trapezoidPerimeter;whiteSpace=wrap;html=1;fixedSize=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="560" y="200" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-20" value="&lt;div&gt;Тело запроса подписывается PGP.Pub&lt;/div&gt;&lt;div&gt;К запросу добавляется &lt;b&gt;CertID&lt;/b&gt;@domain где серт был зареган&lt;br&gt;&lt;/div&gt;" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;size=0.041666666666666664;" vertex="1" parent="1">
          <mxGeometry x="560" y="320" width="240" height="90" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-22" target="ovNifU9Em4_lmZY8JSdp-23">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-22" value="&lt;div&gt;Любой запрос&lt;/div&gt;&lt;div&gt;Сервер&lt;/div&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="895" y="120" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-23" target="ovNifU9Em4_lmZY8JSdp-25">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-23" value="Достаем из запроса где искать серт" style="shape=trapezoid;perimeter=trapezoidPerimeter;whiteSpace=wrap;html=1;fixedSize=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="895" y="200" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-25" value="Форвардим запрос куда надо, либо хэндлим на месте" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="860" y="320" width="190" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-27" target="ovNifU9Em4_lmZY8JSdp-28">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-27" value="&lt;div&gt;Обмен ключами&lt;/div&gt;&lt;div&gt;1x1&lt;br&gt;&lt;/div&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="1155" y="120" width="135" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-28" target="ovNifU9Em4_lmZY8JSdp-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-28" value="&lt;div&gt;Устанавливаем соединение чере WRTC&lt;/div&gt;&lt;div&gt;коммутатор инициатора, и по DataChannel обмениваемся PGP пабликами&lt;br&gt;&lt;/div&gt;" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;size=0.02252252252252252;" vertex="1" parent="1">
          <mxGeometry x="1083.75" y="200" width="277.5" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-30" value="SHA256 от общего ключа == id комнаты&lt;br&gt;Дkя того, чтобы избежать переусложнения с дополнительным согласованием room_id" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;size=0.026785714285714284;" vertex="1" parent="1">
          <mxGeometry x="1082.5" y="320" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-32" target="ovNifU9Em4_lmZY8JSdp-33">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-32" value="&lt;div&gt;Обмен&lt;/div&gt;&lt;div&gt;сообщениями&lt;/div&gt;" style="shape=parallelogram;perimeter=parallelogramPerimeter;whiteSpace=wrap;html=1;fixedSize=1;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="1550" y="120" width="135" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-33" target="ovNifU9Em4_lmZY8JSdp-35">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-33" value="Шлем пейлоуд на федерацию таргета" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1557.5" y="200" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;fillColor=#d5e8d4;strokeColor=#82b366;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-35" target="ovNifU9Em4_lmZY8JSdp-37">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-40" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;fillColor=#f8cecc;strokeColor=#b85450;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-35" target="ovNifU9Em4_lmZY8JSdp-41">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1490" y="440" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-35" value="Доставимо?" style="rhombus;whiteSpace=wrap;html=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1577.5" y="330" width="80" height="80" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-37" value="Пишем в соединение таргета" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1717.5" y="340" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;fillColor=#f8cecc;strokeColor=#b85450;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-41" target="ovNifU9Em4_lmZY8JSdp-42">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;fillColor=#d5e8d4;strokeColor=#82b366;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-41" target="ovNifU9Em4_lmZY8JSdp-44">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-41" value="&lt;div&gt;Есть сервер&lt;/div&gt;&lt;div&gt;Неполученых?&lt;br&gt;&lt;/div&gt;" style="rhombus;whiteSpace=wrap;html=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1410" y="430" width="160" height="120" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-42" value="ERR_POSHEL_NAHUY" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#f8cecc;strokeColor=#b85450;size=0;" vertex="1" parent="1">
          <mxGeometry x="1190" y="460" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-46" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontFamily=Courier New;fillColor=#d5e8d4;strokeColor=#82b366;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-44" target="ovNifU9Em4_lmZY8JSdp-42">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;fillColor=#f8cecc;strokeColor=#b85450;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-44" target="ovNifU9Em4_lmZY8JSdp-47">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-44" value="&lt;div&gt;Достигнут лимит&lt;/div&gt;&lt;div&gt;Хранящихся?&lt;br&gt;&lt;/div&gt;" style="rhombus;whiteSpace=wrap;html=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1410" y="610" width="160" height="130" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontFamily=Courier New;" edge="1" parent="1" source="ovNifU9Em4_lmZY8JSdp-47" target="ovNifU9Em4_lmZY8JSdp-49">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-47" value="Сохраняем сообщение на N секунд" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1670" y="645" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="ovNifU9Em4_lmZY8JSdp-49" value="Шлем таргету пуш" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fontFamily=Courier New;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1870" y="645" width="120" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
